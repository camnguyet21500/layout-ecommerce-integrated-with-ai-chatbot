<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management | Mega Mall</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../css/order_admin.css">
</head>
<body>
<header class="fixed-top">
    <nav class="navbar navbar-expand-lg navbar-light shadow-sm" style="background-color: white; height: 90px;">
        <div class="container-fluid container-fluid-v1">
            <div class="collapse navbar-collapse justify-content-start" id="navbarLeft">
                <ul class="navbar-nav">
                    <!--                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="../customer/index.html">HOME</a></li>-->
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="product_admin.html">PRODUCT</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="category_admin.html">CATEGORY</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="user.html">USER</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="order_admin.html">ORDER</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="role_admin.html">ROLE</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="permission_admin.html">PERMISSION</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="vendor_admin.html">VENDOR</a></li>
                </ul>
            </div>

            <a class="navbar-brand mx-auto d-block" href="../customer/index.html">
                <img src="../../img/mega_mall_logo.png" alt="Logo" width="80">
            </a>

            <div class="icon-right d-flex align-items-center">
                <a href="../admin/profile_admin.html" class="icon-hover mx-3" title="Profile">
                    <i class="far fa-user fa-fw mx-3 "></i>
                </a>
            </div>
        </div>
    </nav>
</header>

<!-- MAIN CONTENT -->
<div class="order-management container mt-5 pt-5">
    <div class="text-center mb-4">
        <h3 class="title-heading">Order Management</h3>
    </div>
    <!-- Actions -->
    <div class="d-flex justify-content-end mb-4">
        <button class="btn-admin btn-export" onclick="exportOrdersToExcel()">
            <i class="fas fa-file-excel mr-2"></i> Export Excel
        </button>
    </div>
    <!-- Orders Table -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="thead-light"><thead class="thead-light">
            <tr>
                <th>STT</th>
                <th>ID</th>
                <th>NAME</th>
                <th>EMAIL</th>
                <th>PHONE NUMBER</th>
                <th>TOTAL</th>
                <th>ORDER DATE</th>
                <th>STATUS</th>
                <th>ACTION</th>
            </tr>
            </thead>
            <tbody id="orderTableBody">
            <tr><td colspan="8" class="text-center py-5 text-muted">
                <i class="fas fa-spinner fa-spin mr-2"></i> Đang tải đơn hàng...
            </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal ORDER DETAILS -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailTitle">Chi tiết đơn hàng</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="orderDetailBody">
                <!-- Dữ liệu sẽ đổ động ở đây -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!--FOOTER-->
<footer class="footer mt-5">
    <div class="top-footer">
        <div class="row footerreponsive">
            <div class="col-sm-3">
                <div class="info_footer end">
                    <div class="logo-top">
                        <a href="" class="logo">
                            <img src="../../img/mega_mall_logo_black.png" style="width: 50%;">
                        </a>
                    </div>
                    <div class="mb-0 content_footer" style="margin-top: 23px;">
                        University of Information Technology (VNUHCM – UIT)<br>
                        (028) 372 52002 <br>
                        (028) 372 52148 <br>
                        info@uit.edu.vn</p>
                    </div>
                    <div class="list-icon">
                        <ul class="list-inline list-unstyled mb-0">
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-twitter"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-weixin"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-weibo"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-skype"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">
                            Help & Information <br>
                            <hr class="hr">
                        </h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="" title="Pagination">Pagination</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Terms & Conditions</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Contact</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Accessories</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Term of use</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">
                            About Us <br>
                            <hr class="hr">
                        </h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="" title="Pagination">Help Center</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Address Store</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Privacy Policy</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Receivers & Amplifiers</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">
                            Profile <br>
                            <hr class="hr">
                        </h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="" title="Pagination">My Account</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Checkout</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Order Tracking</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Help & Support</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <hr style="background-color: white;">
    <div class="copyright" style="color: white;">
        <div class="row align-items-center">
            <div class="col-lg-6 col-md-6  text-lg-left text-md-left">
                <div class="text-copyright mb-0">
                    © Copyright 2025 |
                    <a href="" class="underline_hover bold">
                        Designed
                    </a>
                    by
                    <a href="" class="underline_hover link">
                        Mega Mall
                    </a>
                </div>
                <p></p>
            </div>
        </div>
    </div>
</footer>
<!--END FOOTER-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const BASE_URL = "http://localhost:8888/api";
    let authToken = localStorage.getItem('authToken');

    // Load danh sách đơn hàng
    async function loadOrders() {
        try {
            const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
            const res = await fetch(`${BASE_URL}/orders?itemPerPage=100&page=1`, { headers });
            if (!res.ok) throw new Error("Cannot load orders");
            const data = await res.json();
            let orders = data.data?.list || [];


            let userMap = {};

            if (orders.some(o => o.userID)) {
                try {
                    const userRes = await fetch(`${BASE_URL}/users?itemPerPage=500&page=1`, { headers });
                    if (userRes.ok) {
                        const userJson = await userRes.json();
                        const allUsers = userJson.data?.list || [];

                        allUsers.forEach(u => {
                            if (u.id) {
                                userMap[u.id] = {
                                    name: `${u.firstName || ''} ${u.lastName || ''}`.trim() || 'No name',
                                    email: u.email || '-',
                                    phone: u.phone || '-'
                                };
                            }
                        });
                    } else {
                        console.warn("Không tải được danh sách user, dùng fallback");
                    }
                } catch (err) {
                    console.error("Lỗi fetch users list:", err);

                }
            }

            orders.forEach(order => {
                if (order.userID && userMap[order.userID]) {
                    order.userName = userMap[order.userID].name;
                    order.userEmail = userMap[order.userID].email;
                    order.userPhone = userMap[order.userID].phone;
                } else {
                    order.userName = "Visitor";
                    order.userEmail = "-";
                    order.userPhone = "-";
                }
            });

            renderOrdersTable(orders);

        } catch (err) {
            console.error("Lỗi loadOrders:", err);
            const tbody = document.getElementById("orderTableBody");
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger py-5">Order loading error: ' + err.message + '</td></tr>';
            }
        }
    }

    function renderOrdersTable(orders) {
        const tbody = document.getElementById("orderTableBody");
        tbody.innerHTML = "";

        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">Chưa có đơn hàng nào</td></tr>';
            return;
        }

        orders.forEach((order, index) => {
            const canConfirm = order.status === 'pending';
            const canCancel = order.status === 'pending' || order.status === 'confirmed';

            const row = document.createElement("tr");
            row.dataset.orderId = order.id;
            row.innerHTML = `
      <td>${index + 1}</td>
      <td>${order.id}</td>
      <td><strong>${order.userName || 'Visitors'}</strong></td>
      <td>${order.userEmail || '-'}</td>
      <td>${order.userPhone || '-'}</td>
      <td>${Number(order.totalAmount).toLocaleString('vi-VN')} ₫</td>
      <td>${new Date(order.createdAt).toLocaleDateString('vi-VN')}</td>
      <td><span class="badge badge-${getStatusClass(order.status)}">${getStatusText(order.status)}</span></td>
      <td>
        <button class="btn btn-sm btn-info view-detail mr-1" data-id="${order.id}">Details</button>
        ${canConfirm ? `
          <button class="btn btn-sm btn-success confirm-order mr-1" data-id="${order.id}">
            <i class="fas fa-check"></i> Confirm
          </button>
        ` : ''}
        ${canCancel ? `
          <button class="btn btn-sm btn-danger cancel-order" data-id="${order.id}">
            <i class="fas fa-times"></i> Cancel
          </button>
        ` : ''}
      </td>
    `;
            tbody.appendChild(row);
        });
    }


    $(document).on('click', '.confirm-order', async function() {
        const orderId = $(this).data('id');
        if (!confirm("Are you sure you want to confirm this order?")) return;

        try {
            const headers = {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            };
            const res = await fetch(`${BASE_URL}/orders/${orderId}`, {
                method: 'PATCH',
                headers,
                body: JSON.stringify({ status: 'confirmed' })
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.message || "Update failed");
            }

            showToast("The order has been confirmed!", "success");
            loadOrders();
        } catch (err) {
            showToast("Error when confirming the order: " + err.message, "danger");
        }
    });


    $(document).on('click', '.cancel-order', async function() {
        const orderId = $(this).data('id');
        if (!confirm("Are you sure you want to cancel this order? The action cannot be reversed.")) return;

        try {
            const headers = {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            };
            const res = await fetch(`${BASE_URL}/orders/${orderId}`, {
                method: 'PATCH',
                headers,
                body: JSON.stringify({ status: 'canceled' })
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.message || "Update failed");
            }

            showToast("The order has been cancelled!", "success");
            loadOrders(); // Reload bảng
        } catch (err) {
            showToast("Error while canceling order: " + err.message, "danger");
        }
    });


    function getStatusClass(status) {
        switch (status) {
            case 'pending': return 'warning';
            case 'confirmed': return 'primary';
            case 'processing': return 'info';
            case 'shipped': return 'secondary';
            case 'delivered': return 'success';
            case 'canceled': return 'danger';
            case 'refunded': return 'dark';
            default: return 'secondary';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'pending': return 'Pending';
            case 'confirmed': return 'Confirmed';
            case 'processing': return 'Processing';
            case 'shipped': return 'Shipped';
            case 'delivered': return 'Delivered';
            case 'canceled': return 'Canceled';
            case 'refunded': return 'Refunded';
            default: return status;
        }
    }

    $(document).on('click', '.view-detail', async function() {
        const orderId = $(this).data('id');
        try {
            const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};

            const orderRes = await fetch(`${BASE_URL}/orders/${orderId}?include=user`, { headers });
            if (!orderRes.ok) throw new Error(`Unable to load the order: ${orderRes.status}`);
            const orderData = await orderRes.json();
            const order = orderData.data || orderData;

            let orderItems = order.orderItems || [];
            if (orderItems.length === 0 && order.id) {
                console.log(`[ADMIN DETAIL] Fetching order-items for #${order.id}`);
                const itemsRes = await fetch(`${BASE_URL}/order-items?orderID=${order.id}&itemPerPage=100&page=1`, { headers });
                if (itemsRes.ok) {
                    const itemsData = await itemsRes.json();
                    orderItems = itemsData.data?.list || [];
                }
            }

            let itemsHTML = '';
            let totalAmount = order.totalAmount || 0;
            const productImageFallback = 'https://placehold.co/90x90?text=No+Image';

            if (orderItems.length === 0) {
                itemsHTML = '<p class="text-center text-muted my-4">There are no products in this order.</p>';
            } else {
                for (let item of orderItems) {
                    let productName = 'Unidentified product';
                    let variantInfo = '';
                    let productImage = productImageFallback;
                    let unitPrice = item.unitPrice || item.price || 0;
                    let itemTotal = item.totalPrice || (unitPrice * (item.quantity || 1));

                    if (item.productVariant?.product) {
                        productName = item.productVariant.product.name || productName;
                        if (item.productVariant.product.productImages?.length > 0) {
                            productImage = item.productVariant.product.productImages[0].imageUrl;
                        } else if (item.productVariant.product.imageUrl || item.productVariant.product.mainImageUrl) {
                            productImage = item.productVariant.product.imageUrl || item.productVariant.product.mainImageUrl;
                        }
                    } else if (item.productVariantSnapshot) {
                        try {
                            const snapshot = typeof item.productVariantSnapshot === 'string'
                                ? JSON.parse(item.productVariantSnapshot)
                                : item.productVariantSnapshot;
                            productName = snapshot?.product?.name || snapshot?.name || productName;
                            productImage = snapshot?.product?.productImages?.[0]?.imageUrl
                                || snapshot?.imageUrl
                                || productImage;
                            if (snapshot?.attributes) {
                                variantInfo = `<small class="text-muted">Variant: ${Object.values(snapshot.attributes).filter(v => v).join(' - ')}</small>`;
                            }
                        } catch (e) {}
                    } else if (item.productVariantID) {
                        try {
                            const variantRes = await fetch(`${BASE_URL}/product-variants/${item.productVariantID}`, { headers });
                            if (variantRes.ok) {
                                const variant = (await variantRes.json()).data || {};
                                productName = variant.product?.name || variant.name || productName;
                                productImage = variant.product?.productImages?.[0]?.imageUrl
                                    || variant.product?.imageUrl
                                    || variant.imageUrl
                                    || productImage;
                            }
                        } catch {}
                    }

                    itemsHTML += `
          <div class="d-flex align-items-center mb-3 p-3 border rounded hover-shadow">
            <img src="${productImage}" alt="${productName}"
                 style="width:90px; height:90px; object-fit:cover; border-radius:6px; margin-right:15px;"
                 onerror="this.src='${productImageFallback}'">
            <div class="flex-grow-1">
              <h6 class="mb-1">${productName}</h6>
              ${variantInfo}
              <div class="text-muted small">Số lượng: ${item.quantity || 1} × ${Number(unitPrice).toLocaleString('vi-VN')} ₫</div>
            </div>
            <div class="text-right">
              <strong class="text-danger">${Number(itemTotal).toLocaleString('vi-VN')} ₫</strong>
            </div>
          </div>
        `;
                }
            }

            const user = order.user || {};
            const customerInfo = user.id
                ? `<strong>${user.firstName || ''} ${user.lastName || ''}</strong><br>Email: ${user.email || '-'}<br>Phone: ${user.phone || '-'}<br>Địa chỉ: ${user.fullAddress || 'Không có'}`
                : 'Visitor';

            let shippingAddress = order.shippingAddress || 'None';
            if (order.orderAddresses?.length > 0) {
                const addr = order.orderAddresses.find(a => a.type === 'shipping') || order.orderAddresses[0];
                shippingAddress = addr.fullAddress || shippingAddress;
            }

            const modalHTML = `
      <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between">
          <div>
            <strong>Mã đơn hàng:</strong> #${order.orderNumber || order.id}<br>
            <small class="text-muted">${new Date(order.createdAt).toLocaleString('vi-VN')}</small>
          </div>
          <span class="badge badge-${getStatusClass(order.status)} px-3 py-2">
            ${getStatusText(order.status)}
          </span>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <strong>Khách hàng:</strong><br>${customerInfo}
          </div>
          <strong>Sản phẩm:</strong>
          ${itemsHTML}
          <div class="mt-3 small text-muted">
            <div><i class="fas fa-map-marker-alt mr-2"></i>Địa chỉ: ${shippingAddress}</div>
            <div><i class="fas fa-credit-card mr-2"></i>Thanh toán: ${order.paymentMethod || 'Visitor'}</div>
            ${order.notes ? `<div><i class="fas fa-sticky-note mr-2"></i>Ghi chú: ${order.notes}</div>` : ''}
          </div>
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Tổng tiền:</h5>
            <h4 class="text-danger mb-0">${Number(totalAmount).toLocaleString('vi-VN')} ₫</h4>
          </div>
        </div>
      </div>
    `;

            $('#orderDetailBody').html(modalHTML);
            $('#orderDetailModal').modal('show');

        } catch (err) {
            console.error("Lỗi tải chi tiết:", err);
            $('#orderDetailBody').html(`<div class="alert alert-danger">Lỗi: ${err.message}</div>`);
            $('#orderDetailModal').modal('show');
        }
    });

    function showToast(message, type = 'success') {
        const toastHtml = `
    <div class="toast" role="alert" data-delay="4000">
      <div class="toast-header bg-${type} text-white">
        <strong class="mr-auto">${type === 'success' ? 'Thành công' : 'Lỗi'}</strong>
        <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast"><span>×</span></button>
      </div>
      <div class="toast-body">${message}</div>
    </div>`;
        $('#toastContainer').append(toastHtml);
        $('.toast').last().toast('show');
        $('.toast').last().on('hidden.bs.toast', function () { $(this).remove(); });
    }


    $(document).ready(function() {
        loadOrders();
    });
</script>
<div aria-live="polite" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 1050;">
    <div id="toastContainer"></div>
</div>
</body>
</html>