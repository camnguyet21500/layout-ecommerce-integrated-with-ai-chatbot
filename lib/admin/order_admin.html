<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management | Mega Mall</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../css/order_admin.css">
</head>
<body>
<header class="fixed-top">
    <nav class="navbar navbar-expand-lg navbar-light shadow-sm" style="background-color: white; height: 90px;">
        <div class="container-fluid container-fluid-v1">
            <div class="collapse navbar-collapse justify-content-start" id="navbarLeft">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="../customer/index.html">HOME</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="product_admin.html">PRODUCT</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="category_admin.html">CATEGORY</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="user.html">USER</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="order_admin.html">ORDER</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="role_admin.html">ROLE</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="permission_admin.html">PERMISSION</a></li>
                    <li class="nav-item"><a class="nav-link text-body font-weight-medium" href="vendor_admin.html">VENDOR</a></li>
                </ul>
            </div>
            <a class="navbar-brand mx-auto d-block" href="../customer/index.html">
                <img src="../../img/mega_mall_logo.png" alt="Logo" width="80">
            </a>
        </div>
    </nav>
</header>

<!-- MAIN CONTENT -->
<div class="order-management container mt-5 pt-5">
    <div class="text-center mb-4">
        <h3 class="title-heading">Order Management</h3>
    </div>
    <!-- Actions -->
    <div class="d-flex justify-content-end mb-4">
        <button class="btn-admin btn-export" onclick="exportOrdersToExcel()">
            <i class="fas fa-file-excel mr-2"></i> Export Excel
        </button>
    </div>
    <!-- Orders Table -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="thead-light">
            <tr>
                <th>STT</th>        <!-- Cột mới -->
                <th>ID</th>
                <th>NAME</th>
                <th>EMAIL</th>
                <th>PHONE NUMBER</th>
                <th>TOTAL</th>
                <th>ORDER DATE</th>
                <th>STATUS</th>
                <th>ACTION</th>
            </tr>
            </thead>
            <tbody id="orderTableBody">
            <tr><td colspan="8" class="text-center py-5 text-muted">
                <i class="fas fa-spinner fa-spin mr-2"></i> Đang tải đơn hàng...
            </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal ORDER DETAILS -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailTitle">Chi tiết đơn hàng</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" id="orderDetailBody">
                <!-- Dữ liệu sẽ đổ động ở đây -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!--FOOTER-->
<footer class="footer mt-5">
    <div class="top-footer">
        <div class="row footerreponsive">
            <div class="col-sm-3">
                <div class="info_footer end">
                    <div class="logo-top">
                        <a href="" class="logo">
                            <img src="../../img/mega_mall_logo_black.png" style="width: 50%;">
                        </a>
                    </div>
                    <div class="mb-0 content_footer" style="margin-top: 23px;">
                        University of Information Technology (VNUHCM – UIT)<br>
                        (028) 372 52002 <br>
                        (028) 372 52148 <br>
                        info@uit.edu.vn</p>
                    </div>
                    <div class="list-icon">
                        <ul class="list-inline list-unstyled mb-0">
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-twitter"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-weixin"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-weibo"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-skype"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">
                            Help & Information <br>
                            <hr class="hr">
                        </h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="" title="Pagination">Pagination</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Terms & Conditions</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Contact</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Accessories</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Term of use</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">
                            About Us <br>
                            <hr class="hr">
                        </h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="" title="Pagination">Help Center</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Address Store</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Privacy Policy</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Receivers & Amplifiers</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">
                            Profile <br>
                            <hr class="hr">
                        </h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="" title="Pagination">My Account</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Checkout</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Order Tracking</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Help & Support</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <hr style="background-color: white;">
    <div class="copyright" style="color: white;">
        <div class="row align-items-center">
            <div class="col-lg-6 col-md-6  text-lg-left text-md-left">
                <div class="text-copyright mb-0">
                    © Copyright 2025 |
                    <a href="" class="underline_hover bold">
                        Designed
                    </a>
                    by
                    <a href="" class="underline_hover link">
                        Mega Mall
                    </a>
                </div>
                <p></p>
            </div>
        </div>
    </div>
</footer>
<!--END FOOTER-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const BASE_URL = "http://localhost:8888/api";
    let authToken = localStorage.getItem('authToken'); // Giả sử admin đã login và có token

    // Load danh sách đơn hàng
    async function loadOrders() {
        try {
            const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
            const res = await fetch(`${BASE_URL}/orders?itemPerPage=100&page=1`, { headers });
            if (!res.ok) throw new Error("Không tải được đơn hàng");

            const data = await res.json();
            let orders = data.data.list || [];

            // Fetch thêm thông tin user cho từng order (nếu có userID)
            // === FIX TỐI ƯU: FETCH TẤT CẢ USER CÙNG LÚC (song song) ===
            // === FIX SIÊU TỐI ƯU: Chỉ fetch danh sách users 1 lần duy nhất ===
            let userMap = {}; // Map userID → {name, email, phone}

            if (orders.some(o => o.userID)) { // Chỉ fetch nếu có ít nhất 1 đơn có user
                try {
                    const userRes = await fetch(`${BASE_URL}/users?itemPerPage=500&page=1`, { headers });
                    if (userRes.ok) {
                        const userJson = await userRes.json();
                        const allUsers = userJson.data?.list || [];

                        // Tạo map nhanh
                        allUsers.forEach(u => {
                            if (u.id) {
                                userMap[u.id] = {
                                    name: `${u.firstName || ''} ${u.lastName || ''}`.trim() || 'Không tên',
                                    email: u.email || '-',
                                    phone: u.phone || '-'
                                };
                            }
                        });
                    } else {
                        console.warn("Không tải được danh sách user, dùng fallback");
                    }
                } catch (err) {
                    console.error("Lỗi fetch users list:", err);
                }
            }

// Gán thông tin user cho từng order
            orders.forEach(order => {
                if (order.userID && userMap[order.userID]) {
                    order.userName = userMap[order.userID].name;
                    order.userEmail = userMap[order.userID].email;
                    order.userPhone = userMap[order.userID].phone;
                } else {
                    order.userName = "Khách vãng lai";
                    order.userEmail = "-";
                    order.userPhone = "-";
                }
            });
// === KẾT THÚC FIX ===
// === KẾT THÚC FIX ===

            renderOrdersTable(orders);
        } catch (err) {
            console.error(err);
            $('#ordersTableBody').html('<tr><td colspan="9" class="text-center text-danger">Lỗi tải đơn hàng</td></tr>');
        }
    }

    // Render bảng đơn hàng
    function renderOrdersTable(orders) {
        const tbody = $('#ordersTableBody');
        tbody.empty();

        if (orders.length === 0) {
            tbody.html('<tr><td colspan="9" class="text-center">Chưa có đơn hàng nào</td></tr>');
            return;
        }

        orders.forEach((order, index) => {
            const row = `
                <tr data-order-id="${order.id}">
                    <td>${index + 1}</td>
                    <td>${order.id}</td>
                    <td><strong>${order.userName || 'Khách vãng lai'}</strong></td> <!-- ĐÃ FIX: HIỂN THỊ TÊN -->
                    <td>${order.userEmail || '-'}</td>
                    <td>${order.userPhone || '-'}</td>
                    <td>${order.orderNumber}</td>
                    <td>${Number(order.totalAmount).toLocaleString('vi-VN')} ₫</td>
                    <td>${new Date(order.createdAt).toLocaleDateString('vi-VN')}</td>
                    <td><span class="badge badge-${getStatusClass(order.status)}">${getStatusText(order.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info view-detail" data-id="${order.id}">Xem</button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    // Helper: class cho status badge
    function getStatusClass(status) {
        switch (status) {
            case 'pending': return 'warning';
            case 'confirmed': return 'primary';
            case 'processing': return 'info';
            case 'shipped': return 'secondary';
            case 'delivered': return 'success';
            case 'canceled': return 'danger';
            case 'refunded': return 'dark';
            default: return 'secondary';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'pending': return 'Chờ xác nhận';
            case 'confirmed': return 'Đã xác nhận';
            case 'processing': return 'Đang xử lý';
            case 'shipped': return 'Đang giao';
            case 'delivered': return 'Đã giao';
            case 'canceled': return 'Đã hủy';
            case 'refunded': return 'Đã hoàn tiền';
            default: return status;
        }
    }

    // Xem chi tiết đơn hàng (giữ nguyên như cũ)
    $(document).on('click', '.view-detail', async function() {
        const orderId = $(this).data('id');
        try {
            const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
            const res = await fetch(`${BASE_URL}/orders/${orderId}?include=orderItems,orderItems.productVariant,orderItems.productVariant.product,user`, { headers });
            if (!res.ok) throw new Error("Không tải được chi tiết");

            const data = await res.json();
            const order = data.data;

            // Hiển thị thông tin khách hàng (nếu có)
            let customerInfo = 'Khách vãng lai';
            if (order.user) {
                customerInfo = `
                    <strong>${order.user.firstName} ${order.user.lastName || ''}</strong><br>
                    Email: ${order.user.email || '-'}<br>
                    Phone: ${order.user.phone || '-'}<br>
                    Địa chỉ: ${order.user.fullAddress || '-'}
                `;
            }

            // Render chi tiết sản phẩm
            let itemsHtml = '';
            if (order.orderItems && order.orderItems.length > 0) {
                order.orderItems.forEach(item => {
                    const productName = item.productVariant?.product?.name || 'Sản phẩm không tên';
                    const variantName = item.productVariant?.name || '';
                    const price = Number(item.unitPrice || item.price || 0).toLocaleString('vi-VN');
                    const total = Number(item.totalPrice || item.unitPrice * item.quantity).toLocaleString('vi-VN');

                    itemsHtml += `
                        <tr>
                            <td>${productName} ${variantName}</td>
                            <td>${price} ₫</td>
                            <td>${item.quantity}</td>
                            <td>${total} ₫</td>
                        </tr>
                    `;
                });
            } else {
                itemsHtml = '<tr><td colspan="4" class="text-center">Không có sản phẩm</td></tr>';
            }

            // Cập nhật modal
            $('#modalCustomerInfo').html(customerInfo);
            $('#modalOrderItems').html(itemsHtml);
            $('#modalOrderNumber').text(order.orderNumber);
            $('#modalTotalAmount').text(Number(order.totalAmount).toLocaleString('vi-VN') + ' ₫');
            $('#modalStatus').text(getStatusText(order.status));
            $('#orderDetailModal').modal('show');
        } catch (err) {
            alert("Lỗi tải chi tiết đơn hàng: " + err.message);
        }
    });

    // Load khi mở trang
    $(document).ready(function() {
        loadOrders();
    });
</script>
</body>
</html>