<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product | Mabu Store</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
          integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Popper & Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">

    <!-- Ion Icons -->
    <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.2.3/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.2.3/ionicons/ionicons.js"></script>

    <!-- AngularJS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>

    <!-- Custom CSS & JS -->
    <link rel="stylesheet" href="../../css/product.css">
    <script src="../../js/cart.js"></script>
</head>

<body ng-app="myApp">
<!--HEADER-->
<header>
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: white">
        <div class="container-fluid container-fluid-v1">
            <button class="navbar-toggler" type="button" data-toggle="collapse"
                    data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav">
                    <div class="nav-item">
                        <a class="nav-link text-body" href="../customer/index.html">HOME</a>
                    </div>
                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown2" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">PRODUCT
                            <span class="absolute label_menu">HOT</span>
                        </a>

                        <div class="dropdown-menu dropdown-menu-left border-0 rounded-0"
                             aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
<!--                                <div class="col-sm">-->
<!--                                    <a class="dropdown-item" href="product.html">ALL ITEMS</a>-->
<!--                                    <div class="dropdown-divider"></div>-->
<!--                                    <a class="dropdown-item text-secondary" href="#">Sneaker</a>-->
<!--                                    <a class="dropdown-item text-secondary" href="#">Converse</a>-->
<!--                                    <a class="dropdown-item text-secondary" href="#">Adidas</a>-->
<!--                                </div>-->
                                <div class="col-sm" id="category-list-container">
                                    <a class="dropdown-item" href="product.html">ALL ITEMS</a>
                                    <div class="dropdown-divider"></div>
                                    <div id="dynamic-categories"></div>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">PRODUCTS</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Hot Trend</a>
                                    <a class="dropdown-item text-secondary" href="#">Best Seller</a>
                                    <a class="dropdown-item text-secondary" href="#">Fashion</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">POPULAR</a>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header1.jpg" />
                                                    <ul class="col-sm-7">
                                                        SB Chron British Tan<br>
                                                        $ 500.00
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header2.jpg" />
                                                    <ul class="col-sm-7">
                                                        Converse Chuck Taylor Star<br>
                                                        $ 500.00
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header3.jpg" />
                                                    <ul class="col-sm-7">
                                                        Converse Unisex Shoes<br>
                                                        $ 300.00
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <img src="../../img/img_header.jpg" alt="" style="width: 650px; margin: 25px;">
                        </div>
                    </div>

                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown3" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">FEATURED</a>
                        <div class="dropdown-menu dropdown-menu-left border-0 rounded-0"
                             aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                            </div>
                            <img src="../../img/img_header.jpg" alt="" style="width: 650px; margin: 25px;">
                        </div>
                    </div>

                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown4" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">PAGES</a>
                        <div class="dropdown-menu dropdown-menu-right border-0 rounded-0"
                             aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">BLOGS</a>
                        <div class="dropdown-menu dropdown-menu-right border-0 rounded-0"
                             aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header1.jpg" />
                                                    <ul class="col-sm-7">
                                                        SB Chron British Tan<br>
                                                        $ 500.00
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header2.jpg" />
                                                    <ul class="col-sm-7">
                                                        Converse Chuck Taylor Star<br>
                                                        $ 500.00
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header3.jpg" />
                                                    <ul class="col-sm-7">
                                                        Converse Unisex Shoes<br>
                                                        $ 300.00
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </ul>
            </div>
            <img src="../../img/mega_mall_logo.png" width="5%" style="margin-right: 450px;">
            <form class="form-inline my-2 my-lg-0 search-form mx-auto" style="flex: 1; max-width: 450px;">
                <div class="input-group w-100">
                    <input
                            id="searchInput"
                            class="form-control border-right-0 border"
                            type="search"
                            placeholder="Tìm tên sản phẩm..."
                            aria-label="Search">
                    <div class="input-group-append">
                        <button
                                id="searchBtn"
                                class="btn btn-outline-secondary bg-white border-left-0"
                                type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>
            <div class="icon" style="display: inherit">
                <a href="profile.html"><i class="far fa-user fa-fw mx-3" data-toggle="modal" data-target="#exampleModalCenter"></i></a>
                <a href="notification.html"><i class="fas fa-bell fa-fw mx-3"></i></a>
                <a href="order.html"><i class="fas fa-list-alt fa-fw mx-3"></i></a>
                <a href="cart.html"><i class="fas fa-dolly fa-fw mx-3"></i></a>
            </div>
        </div>
    </nav>
</header>
<!--HEADER END-->

<!-- PRODUCTS GRID -->
<div id="Accessories">
    <div class="tab-pane fade active show">
        <div class="row" style="padding-left: 50px; padding-right: 50px;" id="productGrid"></div>
    </div>
</div>

<!-- PRODUCT DETAIL MODAL -->
<div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-7">
                        <div id="productCarousel" class="carousel slide" data-ride="carousel" data-interval="false">
                            <ol class="carousel-indicators" id="carouselIndicators"></ol>

                            <div class="carousel-inner" id="carouselInner">
                            </div>

                            <a class="carousel-control-prev" href="#productCarousel" role="button" data-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="sr-only">Previous</span>
                            </a>
                            <a class="carousel-control-next" href="#productCarousel" role="button" data-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="sr-only">Next</span>
                            </a>
                        </div>
                    </div>

                    <div class="col-md-5 infor_product">
                        <div class="name" id="modalProductName"></div>
                        <div class="old_price" id="modalOldPrice" style="display: none;"></div>
                        <div class="new_price" id="modalNewPrice"></div>
                        <div class="vote">
                            <i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i>
                            <i class="far fa-star"></i><i class="far fa-star"></i>
                            <span>No reviews</span>
                        </div>
                        <hr>
                        <div class="summary" id="modalDescription">No description available.</div>

                        <div class="active mt-4">
                            <div class="js-qty d-inline-block">
                                <button class="qty-minus btn btn-outline-dark" type="button">-</button>
                                <input type="text" class="js-qty-num form-control text-center d-inline-block mx-2" value="1" style="width: 60px;">
                                <button class="qty-plus btn btn-outline-dark" type="button">+</button>
                            </div>
                            <div class="addtocart d-inline-block ml-3">
                                <a href="#" class="btn btn-warning text-white add-to-cart-btn">ADD TO CART</a>
                            </div>
                        </div>

                        <div class="buyitnow mt-3">
                            <button class="button btn btn-dark">BUY IT NOW</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TOAST CONTAINER -->
<div aria-live="polite" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 1050;">
    <div id="toastContainer"></div>
</div>

<!-- FOOTER -->
<footer class="footer mt-5">
    <div class="top-footer">
        <div class="row footerreponsive">
            <div class="col-sm-3">
                <div class="info_footer end">
                    <div class="logo-top">
                        <a href="" class="logo">
                            <img src="../../img/mega_mall_logo_black.png" style="width: 50%;">
                        </a>
                    </div>
                    <div class="mb-0 content_footer" style="margin-top: 23px;">
                        University of Information Technology (VNUHCM – UIT)<br>
                        (028) 372 52002 <br>
                        (028) 372 52148 <br>
                        info@uit.edu.vn
                    </div>
                    <div class="list-icon">
                        <ul class="list-inline list-unstyled mb-0">
                            <li class="list-inline-item"><a href="" class="social-item"><i class="fab fa-twitter"></i></a></li>
                            <li class="list-inline-item"><a href="" class="social-item"><i class="fab fa-weixin"></i></a></li>
                            <li class="list-inline-item"><a href="" class="social-item"><i class="fab fa-weibo"></i></a></li>
                            <li class="list-inline-item"><a href="" class="social-item"><i class="fab fa-skype"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">Help & Information <br><hr class="hr"></h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li><a href="">Pagination</a></li>
                        <li><a href="">Terms & Conditions</a></li>
                        <li><a href="">Contact</a></li>
                        <li><a href="">Accessories</a></li>
                        <li><a href="">Term of use</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">About Us <br><hr class="hr"></h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li><a href="">Help Center</a></li>
                        <li><a href="">Address Store</a></li>
                        <li><a href="">Privacy Policy</a></li>
                        <li><a href="">Receivers & Amplifiers</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">Profile <br><hr class="hr"></h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li><a href="">My Account</a></li>
                        <li><a href="">Checkout</a></li>
                        <li><a href="">Order Tracking</a></li>
                        <li><a href="">Help & Support</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <hr style="background-color: white;">
    <div class="copyright" style="color: white;">
        <div class="row align-items-center">
            <div class="col-lg-6 col-md-6 text-lg-left text-md-left">
                <div class="text-copyright mb-0">
                    © Copyright 2025 | <a href="" class="underline_hover bold">Designed</a> by <a href="" class="underline_hover link">Mega Mall</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<script>
    const BASE_URL = "http://localhost:8888/api";
    let authToken = null;
    let allProductImages = [];

    function showToast(message, type = 'success') {
        const toastHtml = `
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
          <div class="toast-header bg-${type === 'success' ? 'success' : 'danger'} text-white">
            <strong class="mr-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
            <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="toast-body">${message}</div>
        </div>`;
        $('#toastContainer').append(toastHtml);
        $('.toast').last().toast('show');
        $('.toast').last().on('hidden.bs.toast', function () {
            $(this).remove();
        });
    }

    async function autoLoginAndLoadProducts() {
        try {
            const loginRes = await fetch(`${BASE_URL}/auth/sign-in`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: "nvo28@example.com", password: "nvo28" })
            });

            if (loginRes.ok) {
                const loginData = await loginRes.json();
                authToken = loginData.data.accessToken;
            }
        } catch (err) {
            console.error(err);
        }
        loadProducts();
    }

    let allProducts = [];

    async function loadProducts() {
        try {
            const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
            const productsRes = await fetch(`${BASE_URL}/products?itemPerPage=100&page=1`, { headers });
            if (!productsRes.ok) throw new Error("Failed to load products");

            const productsJson = await productsRes.json();
            allProducts = productsJson.data.list.filter(p => !p.deletedAt && p.status === 'active');

            const selectedCategoryId = getSelectedCategoryId();
            filterProductsByCategory(selectedCategoryId);
        } catch (err) {
            console.error(err);
            document.getElementById("productGrid").innerHTML = '<p class="text-center text-danger">Failed to load products from server</p>';
        }
    }

    function filterProductsByName(query) {
        if (!query || query.trim() === '') {
            renderProducts(allProducts);
            return;
        }

        const filtered = allProducts.filter(product =>
            product.name.toLowerCase().includes(query.toLowerCase())
        );

        renderProducts(filtered);

        if (filtered.length === 0) {
            document.getElementById("productGrid").innerHTML =
                '<p class="text-center mt-5">No products found</p>';
        }
    }

    async function renderProducts(products) {
        const grid = document.getElementById("productGrid");
        grid.innerHTML = "";

        if (products.length === 0) {
            grid.innerHTML = '<p class="text-center">No products available</p>';
            return;
        }

        const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};

        for (const product of products) {
            let mainImage = "../../img/default-product.jpg";
            let allImages = [];

            try {
                const imagesRes = await fetch(`${BASE_URL}/product-images?productID=${product.id}&itemPerPage=100&page=1`, { headers });
                if (imagesRes.ok) {
                    const imagesJson = await imagesRes.json();
                    const productImages = imagesJson.data?.list || [];

                    if (productImages.length > 0) {
                        productImages.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
                        mainImage = productImages[0].imageUrl;
                        allImages = productImages;
                    }
                }
            } catch (err) {
                console.warn(`Failed to load images for product ${product.id}`, err);
            }

            product.mainImage = mainImage;
            product.allImages = allImages;

            const price = Number(product.price).toLocaleString('vi-VN') + ' ₫';
            const item = document.createElement("div");
            item.className = "col-lg-3 col-md-4 col-sm-6 col-6 product-tab-pd";
            item.innerHTML = `
      <div class="product-item-v1">
        <div class="product mb-30 engoj_grid_parent relative">
          <div class="img-product relative">
            <div class="engoj_find_img">
              <img src="${product.mainImage}" alt="${product.name}" style="width: 100%; height: 300px; object-fit: cover;">
            </div>
          </div>
        </div>
        <div class="info-product">
          <h4 class="des-font capital title-product mb-0 flex">
            <a href="#" class="product-detail-link" data-id="${product.id}">${product.name}</a>
          </h4>
          <p class="price-product">
            <span class="price">${price}</span>
          </p>
        </div>
      </div>`;
            grid.appendChild(item);
        }
    }

    $(document).on('click', '.product-detail-link', async function(e) {
        e.preventDefault();
        const id = $(this).data('id');
        try {
            const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
            const res = await fetch(`${BASE_URL}/products/${id}`, { headers });
            if (!res.ok) throw new Error("Failed to load product details");
            const json = await res.json();
            const product = json.data;

            let productImages = product.productImages || [];
            if (productImages.length === 0) {
                productImages = allProductImages.filter(img => img.productID === id);
            }
            productImages.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

            const mainImage = productImages.length > 0 ? productImages[0].imageUrl : "../../img/default-product.jpg";

            $('#modalProductName').text(product.name);
            $('#modalNewPrice').text(Number(product.price).toLocaleString('vi-VN') + ' ₫');
            $('#modalDescription').text(product.description || 'No description available.');
            $('#modalOldPrice').hide();
            $('#productModal').data('productId', product.id);
            $('.js-qty-num').val(1);

            const indicators = $('#carouselIndicators');
            const inner = $('#carouselInner');
            indicators.empty();
            inner.empty();

            if (productImages.length > 0) {
                productImages.forEach((img, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    indicators.append(`<li data-target="#productCarousel" data-slide-to="${index}" class="${isActive}"></li>`);
                    inner.append(`
          <div class="carousel-item ${isActive}">
            <img src="${img.imageUrl}" class="d-block w-100" alt="${product.name}" style="height: 450px; object-fit: contain; background: #f8f9fa;">
          </div>
        `);
                });
            } else {
                inner.append(`
        <div class="carousel-item active">
          <img src="../../img/default-product.jpg" class="d-block w-100" alt="No image" style="height: 450px; object-fit: contain;">
        </div>
      `);
            }

            $('#productModal').modal('show');
        } catch (err) {
            console.error(err);
            showToast("Không thể tải chi tiết sản phẩm", "danger");
        }
    });

    $(document).on('click', '.qty-minus', function() {
        let qty = parseInt($('.js-qty-num').val());
        if (qty > 1) $('.js-qty-num').val(qty - 1);
    });

    $(document).on('click', '.qty-plus', function() {
        let qty = parseInt($('.js-qty-num').val());
        $('.js-qty-num').val(qty + 1);
    });

    $(document).on('click', '.add-to-cart-btn', async function(e) {
        e.preventDefault();
        const authToken = localStorage.getItem('authToken');
        const savedUser = localStorage.getItem('currentUser');
        if (!authToken || !savedUser) {
            showToast("Please log in to add items to cart", "danger");
            window.location.href = 'login.html';
            return;
        }

        const user = JSON.parse(savedUser);
        const userId = user.id;
        const productId = $('#productModal').data('productId');
        const quantity = parseInt($('.js-qty-num').val()) || 1;
        const headers = { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' };

        try {
            let cartId;
            const cartsRes = await fetch(`${BASE_URL}/carts?userID=${userId}&itemPerPage=1&page=1`, { headers });
            if (cartsRes.ok) {
                const cartsData = await cartsRes.json();
                if (cartsData.data?.list?.length > 0) {
                    cartId = cartsData.data.list[0].id;
                }
            }

            if (!cartId) {
                const createCartRes = await fetch(`${BASE_URL}/carts`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ userID: userId })
                });

                if (!createCartRes.ok) {
                    const retryRes = await fetch(`${BASE_URL}/carts?userID=${userId}&itemPerPage=1&page=1`, { headers });
                    if (retryRes.ok) {
                        const retryData = await retryRes.json();
                        if (retryData.data?.list?.length > 0) {
                            cartId = retryData.data.list[0].id;
                        }
                    }
                    if (!cartId) throw new Error("Failed to create cart");
                } else {
                    const createCartData = await createCartRes.json();
                    cartId = createCartData.data.id;
                }
            }

            let productPrice = 0;
            const productDetailRes = await fetch(`${BASE_URL}/products/${productId}`, { headers });
            if (!productDetailRes.ok) throw new Error("Failed to retrieve product info");
            const productDetailJson = await productDetailRes.json();
            const currentProduct = productDetailJson.data;
            productPrice = currentProduct.price || 0;

            let productVariantID;
            const variantsRes = await fetch(`${BASE_URL}/product-variants?productID=${productId}&itemPerPage=10&page=1`, { headers });
            if (variantsRes.ok) {
                const variantsData = await variantsRes.json();
                const variants = variantsData.data?.list || [];
                if (variants.length > 0) {
                    productVariantID = variants[0].id;
                    const updateVariantRes = await fetch(`${BASE_URL}/product-variants/${productVariantID}`, {
                        method: 'PATCH',
                        headers,
                        body: JSON.stringify({ price: productPrice })
                    });
                } else {
                    const createVariantRes = await fetch(`${BASE_URL}/product-variants`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ productID: productId, price: productPrice })
                    });
                    if (!createVariantRes.ok) throw new Error("Failed to create variant");
                    const createVariantData = await createVariantRes.json();
                    productVariantID = createVariantData.data.id;
                }
            } else {
                throw new Error("Failed to check variants");
            }

            let existingCartItem = null;
            const cartItemsRes = await fetch(`${BASE_URL}/cart-items?cartID=${cartId}&itemPerPage=100&page=1`, { headers });
            if (cartItemsRes.ok) {
                const cartItemsData = await cartItemsRes.json();
                const cartItems = cartItemsData.data?.list || [];
                existingCartItem = cartItems.find(item => item.productVariantID === productVariantID);
            }

            if (existingCartItem) {
                const newQuantity = (existingCartItem.quantity || 1) + quantity;
                const updateRes = await fetch(`${BASE_URL}/cart-items/${existingCartItem.id}`, {
                    method: 'PATCH',
                    headers,
                    body: JSON.stringify({ quantity: newQuantity })
                });
                if (!updateRes.ok) throw new Error("Failed to update quantity");
            } else {
                const addRes = await fetch(`${BASE_URL}/cart-items`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ cartID: cartId, productVariantID: productVariantID, quantity: quantity })
                });
                if (!addRes.ok) throw new Error("Failed to add product");
            }

            showToast("Added successfully!", 'success');
            $('#productModal').modal('hide');

            localStorage.setItem('just_added_to_cart', 'true');

            setTimeout(() => {
                window.location.href = 'cart.html';
            }, 2000);
        } catch (err) {
            console.error(err);
            showToast("Failed to add to cart: " + err.message, "danger");
        }
    });

    async function loadCategoriesForMenu() {
        console.log("[DEBUG] Bắt đầu loadCategoriesForMenu()");
        console.log("[DEBUG] authToken hiện tại:", authToken ? "Có token" : "Chưa có token (null)");

        const container = document.getElementById('dynamic-categories');
        if (!container) {
            console.error("[ERROR] Không tìm thấy #dynamic-categories trong DOM!");
            return;
        }
        console.log("[DEBUG] Đã tìm thấy container #dynamic-categories");

        try {
            const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
            console.log("[DEBUG] Gọi API: /categories?parentID=null&itemPerPage=20&page=1");

            const res = await fetch(`${BASE_URL}/categories?itemPerPage=20&page=1`, { headers });

            console.log("[DEBUG] API response status:", res.status);

            if (!res.ok) {
                const errorText = await res.text();
                console.warn("[WARN] API categories thất bại:", res.status, errorText);
                container.innerHTML = '<a class="dropdown-item text-muted">Lỗi tải danh mục</a>';
                return;
            }

            const json = await res.json();
            console.log("[DEBUG] Dữ liệu API trả về:", json);

            const categories = json.data?.list || [];
            console.log("[DEBUG] Số lượng category:", categories.length);

            container.innerHTML = '';  // xóa nội dung cũ

            if (categories.length === 0) {
                container.innerHTML = '<a class="dropdown-item text-muted">Chưa có danh mục nào</a>';
                console.log("[INFO] Không có category nào (list rỗng)");
                return;
            }

            categories.forEach(cat => {
                const link = document.createElement('a');
                link.className = 'dropdown-item text-secondary';
                link.href = `product.html?category=${cat.id}`;
                link.textContent = cat.name || 'Unnamed Category';
                container.appendChild(link);
                console.log("[DEBUG] Đã thêm category:", cat.name, cat.id);
            });

            console.log("[SUCCESS] Đã render xong categories");
        } catch (err) {
            console.error("[ERROR] Lỗi khi load categories:", err);
            container.innerHTML = '<a class="dropdown-item text-danger">Lỗi hệ thống</a>';
        }
    }

    // Đọc category từ URL query param
    function getSelectedCategoryId() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('category'); // trả về id hoặc null
    }

    function filterProductsByCategory(categoryId) {
        if (!categoryId) {
            renderProducts(allProducts);
            return;
        }

        const filtered = allProducts.filter(product => {
            return product.productCategories?.some(pc => pc.categoryID === categoryId);
        });

        renderProducts(filtered);

        if (filtered.length === 0) {
            document.getElementById("productGrid").innerHTML =
                '<p class="text-center mt-5">There are no products in this category.</p>';
        }
    }

    $(document).ready(async function() {
        try {
            await autoLoginAndLoadProducts();
            loadCategoriesForMenu();
        } catch (err) {
            console.error("Lỗi khởi tạo trang:", err);
        }

        document.getElementById('searchBtn')?.addEventListener('click', () => {
            const query = document.getElementById('searchInput').value;
            filterProductsByName(query);
        });

        document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('searchBtn').click();
            }
        });

        document.getElementById('searchInput')?.addEventListener('input', function() {
            filterProductsByName(this.value);
        });
    });
</script>
</body>
</html>
