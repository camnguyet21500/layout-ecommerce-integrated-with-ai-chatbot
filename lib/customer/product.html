<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product | Mabu Store</title>
    <!--CDN CSS-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <!--JS library: Full jQuery first-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <!-- ION ICON: Fix warning by using module/nomodule -->
    <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.2.3/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.2.3/ionicons/ionicons.js"></script>
    <!--Angular-->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <!-- CSS -->
    <link rel="stylesheet" href="../../css/product.css">
    <!-- JS -->
    <script src="../../js/cart.js"></script>
</head>
</head>
<body ng-app="myApp">
<!-- HEADER -->
<header>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" style="background-color: white">
        <div class="container-fluid container-fluid-v1">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav">
                    <div class="dropdown">
                        <a class="nav-link text-body" href="index.html" id="navbarDropdown" role="button">HOME</a>
                    </div>
                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">SHOP <span class="absolute label_menu">HOT</span></a>
                        <div class="dropdown-menu dropdown-menu-left border-0 rounded-0" aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">FEATURED</a>
                        <div class="dropdown-menu dropdown-menu-left border-0 rounded-0" aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                            </div>
                            <img src="../../img/img_header.jpg" alt="" style="width: 650px; margin: 25px;">
                        </div>
                    </div>
                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">PAGES</a>
                        <div class="dropdown-menu dropdown-menu-right border-0 rounded-0" aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">BLOGS</a>
                        <div class="dropdown-menu dropdown-menu-right border-0 rounded-0" aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header3.jpg" />
                                                    <ul class="col-sm-7"> SB Chron British Tan<br> $ 500.00 </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header2.jpg" />
                                                    <ul class="col-sm-7"> Converse Chuck Taylor Star<br> $ 500.00 </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header3.jpg" />
                                                    <ul class="col-sm-7"> Converse Unisex Shoes<br> $ 300.00 </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </ul>
            </div>
            <img src="../../img/mega_mall_logo.png" width="5%" style="margin-right: 450px;">
            <div class="icon" style="display: inherit">
<!--                <i class="fas fa-search"></i>-->
                <a href="profile.html"><i class="far fa-user fa-fw mx-3"></i></a>
                <a href="notification.html"><i class="fas fa-bell fa-fw mx-3"></i></a>
                <a href="order.html"><i class="fas fa-list-alt fa-fw mx-3"></i></a>
                <a href="cart.html"><i class="fas fa-dolly fa-fw mx-3"></i></a>
            </div>
        </div>
    </nav>
    <div class="bgr">
        <div class="jumbotron jumbotron-fluid">
            <h1 class="display-4" style="font-weight: 500; letter-spacing: 2px;">Product</h1>
            <p class="lead">
                <a href="">Home</a> > Products
            </p>
            <div class="container">
                <div class="img_banner">
                    <div class="items">
                        <img src="../../img/container_product1.jpg" alt="">
                        <div class="text_banner">
                            <a href="">ALL ITEMS</a>
                        </div>
                    </div>
                    <div class="items">
                        <img src="../../img/container_product2.jpg" alt="">
                        <div class="text_banner">
                            <a href="">HOT TREND</a>
                        </div>
                    </div>
                    <div class="items">
                        <img src="../../img/container_product3.jpg" alt="">
                        <div class="text_banner">
                            <a href="">BEST SELLER</a>
                        </div>
                    </div>
                    <div class="items">
                        <img src="../../img/container_product4.jpg" alt="">
                        <div class="text_banner">
                            <a href="">FASHION</a>
                        </div>
                    </div>
                    <!-- <img src="img/container_product5.jpg" alt=""> -->
                    <!-- <img src="img/container_product6.jpg" alt=""> <img src="img/container_product7.jpg" alt=""> <img src="img/container_product8.jpg" alt=""> -->
                </div>
            </div>
        </div>
    </div>
</header>
<!-- END HEADER -->
<!-- ITEMS -->
<div class="filter">
    <a href="" class="btnfilter"><i class="fas fa-filter"></i>FILTER</a>
</div>
<div id="Accessories">
    <div class="tab-pane fade active show">
        <div class="row" style="padding-left: 50px; padding-right: 50px;" id="productGrid">
            <!-- Dữ liệu sản phẩm sẽ được render động ở đây -->
        </div>
    </div>
</div>
<div class="loadmore">
    <a href="" class="btnloadmore">LOAD MORE</a>
</div>
<!-- END ITEMS -->
<!-- PRODUCT DETAIL MODAL – CHUNG CHO TẤT CẢ SẢN PHẨM -->
<!-- PRODUCT DETAIL MODAL – GIỐNG HỆT TEST.HTML -->
<div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <div class="bread_crumb">
                    <div class="product row">
                        <div class="col-md-6">
                            <img id="modalProductImage" src="" alt="" class="img-fluid">
                        </div>
                        <div class="col-md-6 infor_product">
                            <div class="name" id="modalProductName"></div>
                            <div class="old_price" id="modalOldPrice" style="display: none;"></div>
                            <div class="new_price" id="modalNewPrice"></div>
                            <div class="vote">
                                <i class="far fa-star"></i>
                                <i class="far fa-star"></i>
                                <i class="far fa-star"></i>
                                <i class="far fa-star"></i>
                                <i class="far fa-star"></i>
                                <span>No reviews</span>
                            </div>
                            <hr>
                            <div class="summary" id="modalDescription">Không có mô tả</div>
                            <div class="active mt-4">
                                <div class="js-qty d-inline-block">
                                    <button class="qty-minus btn btn-outline-dark" type="button">-</button>
                                    <input type="text" class="js-qty-num form-control text-center d-inline-block mx-2" value="1" style="width: 60px;">
                                    <button class="qty-plus btn btn-outline-dark" type="button">+</button>
                                </div>
                                <div class="addtocart d-inline-block ml-3">
                                    <a href="#" class="btn btn-warning text-white add-to-cart-btn">ADD TO CART</a>
                                </div>
                            </div>
                            <div class="buyitnow mt-3">
                                <button class="button btn btn-dark">BUY IT NOW</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--FOOTER-->
<footer class="footer mt-5">
    <div class="top-footer">
        <div class="row footerreponsive">
            <div class="col-sm-3">
                <div class="info_footer end">
                    <div class="logo-top">
                        <a href="" class="logo">
                            <img src="../../img/mega_mall_logo_black.png" style="width: 50%;">
                        </a>
                    </div>
                    <div class="mb-0 content_footer" style="margin-top: 23px;">
                        University of Information Technology (VNUHCM – UIT)<br>
                        (028) 372 52002 <br>
                        (028) 372 52148 <br>
                        info@uit.edu.vn</p>
                    </div>
                    <div class="list-icon">
                        <ul class="list-inline list-unstyled mb-0">
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-twitter"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-weixin"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-weibo"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-skype"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">
                            Help & Information <br>
                            <hr class="hr">
                        </h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="" title="Pagination">Pagination</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Terms & Conditions</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Contact</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Accessories</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Term of use</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">
                            About Us <br>
                            <hr class="hr">
                        </h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="" title="Pagination">Help Center</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Address Store</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Privacy Policy</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Receivers & Amplifiers</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">
                            Profile <br>
                            <hr class="hr">
                        </h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="" title="Pagination">My Account</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Checkout</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Order Tracking</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Help & Support</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <hr style="background-color: white;">
    <div class="copyright" style="color: white;">
        <div class="row align-items-center">
            <div class="col-lg-6 col-md-6  text-lg-left text-md-left">
                <div class="text-copyright mb-0">
                    © Copyright 2025 |
                    <a href="" class="underline_hover bold">
                        Designed
                    </a>
                    by
                    <a href="" class="underline_hover link">
                        Mega Mall
                    </a>
                </div>
                <p></p>
            </div>
        </div>
    </div>
</footer>

<!--END FOOTER-->
<script>
    const BASE_URL = "http://localhost:8888/api";
    let authToken = null;
    // Tự động login để lấy token (dùng tài khoản public hoặc guest nếu có)
    async function autoLoginAndLoadProducts() {
        try {
            // Thử login với tài khoản có sẵn (nvo28@example.com)
            const loginRes = await fetch(`${BASE_URL}/auth/sign-in`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: "nvo28@example.com", password: "nvo28" })
            });
            if (loginRes.ok) {
                const loginData = await loginRes.json();
                authToken = loginData.data.accessToken;
                console.log("Login thành công, đang tải sản phẩm...");
            } else {
                console.warn("Login thất bại, thử gọi API public...");
                // Nếu login fail → vẫn thử gọi API (có thể backend cho public)
            }
            loadProducts();
        } catch (err) {
            console.error("Lỗi login:", err);
            loadProducts(); // Vẫn thử gọi API dù không có token
        }
    }

    let allProductImages = []; // Lưu toàn bộ ảnh để dùng chung
    async function loadProducts() {
        try {
            const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
            // 1. Load danh sách sản phẩm
            const productsRes = await fetch(`${BASE_URL}/products?itemPerPage=100&page=1`, { headers });
            if (!productsRes.ok) throw new Error("Không tải được sản phẩm");
            const productsJson = await productsRes.json();
            let products = productsJson.data.list.filter(p => !p.deletedAt && p.status === 'active');

            // 2. Load tất cả ảnh sản phẩm
            const imagesRes = await fetch(`${BASE_URL}/product-images?itemPerPage=5000&page=1`, { headers });
            if (!imagesRes.ok) {
                console.warn("Không load được ảnh, dùng ảnh default");
                allProductImages = [];
            } else {
                const imagesJson = await imagesRes.json();
                allProductImages = imagesJson.data?.list || [];
            }

            // 3. Map ảnh theo productID
            const imagesMap = {};
            allProductImages.forEach(img => {
                if (!imagesMap[img.productID]) imagesMap[img.productID] = [];
                imagesMap[img.productID].push(img);
            });

            // 4. Gắn ảnh vào từng sản phẩm
            products = products.map(product => {
                const imgs = imagesMap[product.id] || [];
                if (imgs.length > 0) {
                    // Sắp xếp theo sortOrder nếu có, nếu không thì lấy cái đầu
                    imgs.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
                }
                product.mainImage = imgs.length > 0 ? imgs[0].imageUrl : "../../img/default-product.jpg";
                product.allImages = imgs; // Dùng cho modal chi tiết
                return product;
            });

            renderProducts(products);
        } catch (err) {
            console.error("Lỗi load sản phẩm:", err);
            document.getElementById("productGrid").innerHTML = '<p class="text-center text-danger">Lỗi tải sản phẩm từ server</p>';
        }
    }

    function renderProducts(products) {
        const grid = document.getElementById("productGrid");
        grid.innerHTML = "";
        if (products.length === 0) {
            grid.innerHTML = '<p class="text-center">Chưa có sản phẩm nào</p>';
            return;
        }
        products.forEach(product => {
            const price = Number(product.price).toLocaleString('vi-VN') + ' ₫';
            const item = document.createElement("div");
            item.className = "col-lg-3 col-md-4 col-sm-6 col-6 product-tab-pd";
            item.innerHTML = `
                    <div class="product-item-v1">
                        <div class="product mb-30 engoj_grid_parent relative">
                            <div class="img-product relative">
                                <div class="engoj_find_img">
                                    <img src="${product.mainImage}" alt="${product.name}" style="width: 100%; height: 300px; object-fit: cover;">
                                </div>
                            </div>
                        </div>
                        <div class="info-product">
                            <h4 class="des-font capital title-product mb-0 flex">
                                <a href="#" class="product-detail-link" data-id="${product.id}">
                                    ${product.name}
                                </a>
                            </h4>
                            <p class="price-product">
                                <span class="price">${price}</span>
                            </p>
                        </div>
                    </div>
                `;
            grid.appendChild(item);
        });
    }

    // Xử lý click xem chi tiết sản phẩm
    $(document).on('click', '.product-detail-link', async function(e) {
        e.preventDefault();
        const id = $(this).data('id');
        try {
            const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
            const res = await fetch(`${BASE_URL}/products/${id}`, { headers });
            if (!res.ok) throw new Error("Lỗi load chi tiết");
            const json = await res.json();
            let product = json.data;
            // Nếu chi tiết không có ảnh → dùng từ allProductImages
            if (!product.productImages || product.productImages.length === 0) {
                const imgs = allProductImages.filter(img => img.productID === id);
                if (imgs.length > 0) {
                    imgs.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
                    product.mainImage = imgs[0].imageUrl;
                } else {
                    product.mainImage = "../../img/default-product.jpg";
                }
            } else {
                product.mainImage = product.productImages[0]?.imageUrl || "../../img/default-product.jpg";
            }
            const price = Number(product.price).toLocaleString('vi-VN') + ' ₫';
            $('#modalProductImage').attr('src', product.mainImage);
            $('#modalProductName').text(product.name);
            $('#modalNewPrice').text(price);
            $('#modalDescription').text(product.description || 'Không có mô tả sản phẩm.');
            $('#modalOldPrice').hide();
            // Lưu productId vào modal để dùng cho add to cart
            $('#productModal').data('productId', product.id);
            // Reset quantity về 1
            $('.js-qty-num').val(1);
            $('#productModal').modal('show');
        } catch (err) {
            console.error(err);
            alert("Lỗi load chi tiết sản phẩm!");
        }
    });

    // Handle qty buttons in modal
    $(document).on('click', '.qty-minus', function() {
        let qty = parseInt($('.js-qty-num').val());
        if (qty > 1) $('.js-qty-num').val(qty - 1);
    });
    $(document).on('click', '.qty-plus', function() {
        let qty = parseInt($('.js-qty-num').val());
        $('.js-qty-num').val(qty + 1);
    });

    // Handle ADD TO CART (đã fix unique constraint)
    // Handle ADD TO CART (đã fix unique constraint và DTO fields)
    $(document).on('click', '.add-to-cart-btn', async function(e) {
        e.preventDefault();

        // Kiểm tra login (dùng localStorage như code gốc của bạn)
        const authToken = localStorage.getItem('authToken');
        const savedUser = localStorage.getItem('currentUser');
        if (!authToken || !savedUser) {
            alert("Vui lòng đăng nhập để thêm vào giỏ hàng!");
            window.location.href = 'login.html';
            return;
        }

        const user = JSON.parse(savedUser);
        const userId = user.id;
        const productId = $('#productModal').data('productId');
        const quantity = parseInt($('.js-qty-num').val()) || 1;

        const headers = {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
        };

        try {
            let cartId;

            // Bước 1: Tìm cart hiện có của user (query đúng theo backend: userID - chữ hoa ID)
            const cartsRes = await fetch(`${BASE_URL}/carts?userID=${userId}&itemPerPage=1&page=1`, { headers });
            if (cartsRes.ok) {
                const cartsData = await cartsRes.json();
                if (cartsData.data?.list?.length > 0) {
                    cartId = cartsData.data.list[0].id;
                }
            }

            // Bước 2: NẾU VẪN KHÔNG CÓ CART → mới tạo (nhưng thực tế hiếm xảy ra vì unique)
            // Quan trọng: Nếu đã có cart rồi → KHÔNG tạo nữa → tránh lỗi unique
            if (!cartId) {
                const createCartRes = await fetch(`${BASE_URL}/carts`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ userID: userId })  // đúng field backend yêu cầu
                });

                // Nếu tạo fail vì đã tồn tại (500 unique) → thử tìm lại cart một lần nữa
                if (!createCartRes.ok) {
                    // Thử tìm lại cart (có thể cart đã được tạo từ session khác)
                    const retryRes = await fetch(`${BASE_URL}/carts?userID=${userId}&itemPerPage=1&page=1`, { headers });
                    if (retryRes.ok) {
                        const retryData = await retryRes.json();
                        if (retryData.data?.list?.length > 0) {
                            cartId = retryData.data.list[0].id;
                        }
                    }

                    if (!cartId) {
                        const errData = await createCartRes.json();
                        throw new Error("Lỗi tạo cart: " + (errData.errors?.[0]?.message || createCartRes.status));
                    }
                } else {
                    const createCartData = await createCartRes.json();
                    cartId = createCartData.data.id;
                }
            }

            // Bước mới: Lấy hoặc tạo variant cho sản phẩm
            // Bước mới: Lấy hoặc tạo variant cho sản phẩm
            let productVariantID;
            let productPrice = 0;

// Fetch chi tiết sản phẩm để lấy giá
            const productDetailRes = await fetch(`${BASE_URL}/products/${productId}`, { headers });
            if (!productDetailRes.ok) {
                throw new Error("Không thể lấy thông tin sản phẩm");
            }
            const productDetailJson = await productDetailRes.json();
            const currentProduct = productDetailJson.data;
            productPrice = currentProduct.price || 0;

// Fetch variants
            const variantsRes = await fetch(`${BASE_URL}/product-variants?productID=${productId}&itemPerPage=10&page=1`, { headers });

            if (variantsRes.ok) {
                const variantsData = await variantsRes.json();
                const variants = variantsData.data?.list || [];

                if (variants.length > 0) {
                    productVariantID = variants[0].id;
                } else {
                    // Tạo variant mới - chỉ gửi field cần thiết
                    const createVariantRes = await fetch(`${BASE_URL}/product-variants`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({
                            productID: productId,
                            price: productPrice
                        })
                    });

                    if (!createVariantRes.ok) {
                        const errData = await createVariantRes.json();
                        throw new Error("Không thể tạo variant tự động: " + (errData.message || createVariantRes.status));
                    }

                    const createVariantData = await createVariantRes.json();
                    productVariantID = createVariantData.data.id;
                }
            } else {
                throw new Error("Lỗi kết nối khi kiểm tra variant");
            }

            // Bước 3: Add item vào cart với fields đúng: cartID, productVariantID, quantity
            const addRes = await fetch(`${BASE_URL}/cart-items`, {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    cartID: cartId,
                    productVariantID: productVariantID,
                    quantity: quantity
                })
            });

            if (!addRes.ok) {
                const errData = await addRes.json();
                throw new Error("Lỗi thêm sản phẩm: " + (errData.message || addRes.status));
            }

            alert("Đã thêm vào giỏ hàng thành công!");
            $('#productModal').modal('hide');

        } catch (err) {
            console.error(err);
            alert("Lỗi thêm vào giỏ hàng: " + err.message);
        }
    });

    // Chạy khi load trang
    $(document).ready(function() {
        autoLoginAndLoadProducts();
    });
</script>
</body>
</html>