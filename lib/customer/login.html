<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Mega Mall</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="../../css/login.css">
</head>
<body>

<div class="login-card">
    <div class="login-header">
        <img src="../../img/mega_mall_logo.png" alt="Mega Mall Logo">
        <h3>MEGA MALL</h3>
        <p>Welcome back!</p>
    </div>

    <div class="login-body">
        <form id="loginForm">
            <div class="form-group">
                <input type="email" class="form-control" id="loginEmail" placeholder="Email address" required>
            </div>

            <div class="form-group">
                <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
            </div>

            <div id="loginError" class="text-danger text-center mb-3" style="display:none;"></div>

            <button type="submit" class="btn btn-login text-white">LOG IN</button>
        </form>

        <div class="text-center mt-3">
            <p>Don't have an account? <a href="#" class="text-link">Sign up</a></p>
        </div>
    </div>
</div>

<div aria-live="polite" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 1050;">
    <div id="loginToast" class="toast" data-delay="2000">
        <div class="toast-header">
            <strong class="mr-auto" id="toastTitle"></strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast">&times;</button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<script>
    const BASE_URL = "http://localhost:8888/api";

    function showToast(title, message, success = true) {
        $('#toastTitle').text(title);
        $('#toastMessage').text(message);
        $('#loginToast')
            .removeClass('bg-success bg-danger text-white')
            .addClass(success ? 'bg-success text-white' : 'bg-danger text-white')
            .toast('show');
    }

    $('#loginForm').on('submit', async function(e) {
        e.preventDefault();
        $('#loginError').hide().text('');

        const email = $('#loginEmail').val().trim();
        const password = $('#loginPassword').val();

        if (!email || !password) {
            $('#loginError').text('Please enter both email and password.').show();
            return;
        }

        try {
            const loginRes = await fetch(`${BASE_URL}/auth/sign-in`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const loginData = await loginRes.json();

            if (!loginRes.ok || !loginData.data?.accessToken) {
                const msg = loginData.message || 'Invalid email or password.';
                $('#loginError').text(msg).show();
                return;
            }

            const token = loginData.data.accessToken;
            localStorage.setItem('authToken', token);

            const userRes = await fetch(`${BASE_URL}/users?email=${encodeURIComponent(email)}&itemPerPage=1&page=1`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const userData = await userRes.json();
            let user = null;

            if (userRes.ok && userData.data?.list?.length > 0) {
                user = userData.data.list[0];
            } else {
                user = { email };
                showToast("Login Notice", "Login successful, but user profile could not be fully loaded.", false);
            }

            localStorage.setItem('currentUser', JSON.stringify(user));
            if (user.id) {
                localStorage.setItem('currentUserId', user.id);
            }

            showToast("Success", "Login successful!");
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1200);

        } catch (err) {
            console.error("Connection error:", err);
            $('#loginError').text('Server connection error. Please try again later.').show();
        }
    });
</script>

</body>
</html>
