<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart | Mabu Store</title>
    <!--CDN CSS-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <!--JS library: Full jQuery first-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <!-- ION ICON: Fix warning -->
    <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.2.3/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.2.3/ionicons/ionicons.js"></script>
    <!--Angular--> <!-- Remove if not used, or implement controller -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <!-- CSS -->
    <link rel="stylesheet" href="../../css/cart.css">
</head>
<body> <!-- Removed ng-app and ng-controller, use jQuery instead -->
<!-- HEADER -->
<header>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" style="background-color: white">
        <div class="container-fluid container-fluid-v1">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav">
                    <div class="dropdown">
                        <a class="nav-link text-body" href="index.html" id="navbarDropdown" role="button">HOME</a>
                    </div>
                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">SHOP <span class="absolute label_menu">HOT</span> </a>
                        <div class="dropdown-menu dropdown-menu-left border-0 rounded-0" aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">FEATURED</a>
                        <div class="dropdown-menu dropdown-menu-left border-0 rounded-0" aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                            </div>
                            <img src="../../img/img_header.jpg" alt="" style="width: 650px; margin: 25px;">
                        </div>
                    </div>
                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">PAGES</a>
                        <div class="dropdown-menu dropdown-menu-right border-0 rounded-0" aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">BLOGS</a>
                        <div class="dropdown-menu dropdown-menu-right border-0 rounded-0" aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header1.jpg" />
                                                    <ul class="col-sm-7"> SB Chron British Tan<br> $ 500.00 </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header2.jpg" />
                                                    <ul class="col-sm-7"> Converse Chuck Taylor Star<br> $ 500.00 </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header3.jpg" />
                                                    <ul class="col-sm-7"> Converse Unisex Shoes<br> $ 300.00 </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </ul>
            </div>
            <img src="../../img/mega_mall_logo.png" width="5%" style="margin-right: 450px;">
            <div class="icon" style="display: inherit">
<!--                <i class="fas fa-search"></i>-->
                <a href="profile.html"><i class="far fa-user fa-fw mx-3"></i></a>
                <a href="notification.html"><i class="fas fa-bell fa-fw mx-3"></i></a>
                <a href="order.html"><i class="fas fa-list-alt fa-fw mx-3"></i></a>
                <a href="cart.html"><i class="fas fa-dolly fa-fw mx-3"></i></a>
            </div>
        </div>
    </nav>
    <div class="bgr">
        <div class="jumbotron jumbotron-fluid">
            <h1 class="display-4" style="color: white;">Cart</h1>
            <p class="lead" style="color: white;">
                <a href="" style="color: white;">Home</a> > Your shopping cart
            </p>
        </div>
    </div>
</header>
<!-- END HEADER -->
<!-- CART -->
<section>
    <div class="container">
        <table class="table">
            <thead>
            <tr>
                <th scope="col">PRODUCT NAME</th>
                <th scope="col">PRICE</th>
                <th scope="col">QUANTITY</th>
                <th scope="col">TOTAL</th>
                <th scope="col">ACTION</th> <!-- Thêm cột remove -->
            </tr>
            </thead>
            <tbody id="cartItemsBody">
            <!-- Cart items sẽ render động ở đây -->
            </tbody>
        </table>
        <div class="cart-update">
            <input type="submit" class="button" value="UPDATE CART" id="updateCartBtn">
        </div>
        <div class="continue-shopping">
            <a href="">CONTINUE SHOPPING</a>
        </div>
        <div class="cart-check">
            <h2 class="cart-title">CART TOTAL</h2>
            <table class="total-checkout">
                <tbody>
                <tr>
                    <th class="cart-label">
                        <span>Total</span>
                    </th>
                    <td class="cart-amount">
                                <span>
                                    <strong>
                                        <span id="cartTotal" class="amount">0 ₫</span>
                                    </strong>
                                </span>
                    </td>
                </tr>
                </tbody>
            </table>
            <div class="proceed-to-checkout">
                <a href="" class="checkout-button"> PROCEED TO CHECKOUT </a>
            </div>
        </div>
    </div>
</section>
<!-- END CART -->
<!--FOOTER-->
<footer class="footer mt-5">
    <div class="top-footer">
        <div class="row footerreponsive">
            <div class="col-sm-3">
                <div class="info_footer end">
                    <div class="logo-top">
                        <a href="" class="logo">
                            <img src="../../img/mega_mall_logo_black.png" style="width: 50%;">
                        </a>
                    </div>
                    <div class="mb-0 content_footer" style="margin-top: 23px;">
                        University of Information Technology (VNUHCM – UIT)<br>
                        (028) 372 52002 <br>
                        (028) 372 52148 <br>
                        info@uit.edu.vn</p>
                    </div>
                    <div class="list-icon">
                        <ul class="list-inline list-unstyled mb-0">
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-twitter"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-weixin"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-weibo"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="" class="social-item">
                                    <i class="fab fa-skype"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">
                            Help & Information <br>
                            <hr class="hr">
                        </h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="" title="Pagination">Pagination</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Terms & Conditions</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Contact</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Accessories</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Term of use</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">
                            About Us <br>
                            <hr class="hr">
                        </h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="" title="Pagination">Help Center</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Address Store</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Privacy Policy</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Receivers & Amplifiers</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">
                            Profile <br>
                            <hr class="hr">
                        </h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="" title="Pagination">My Account</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Checkout</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Order Tracking</a>
                        </li>
                        <li>
                            <a href="" title="Pagination">Help & Support</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <hr style="background-color: white;">
    <div class="copyright" style="color: white;">
        <div class="row align-items-center">
            <div class="col-lg-6 col-md-6  text-lg-left text-md-left">
                <div class="text-copyright mb-0">
                    © Copyright 2025 |
                    <a href="" class="underline_hover bold">
                        Designed
                    </a>
                    by
                    <a href="" class="underline_hover link">
                        Mega Mall
                    </a>
                </div>
                <p></p>
            </div>
        </div>
    </div>
</footer>

<!--END FOOTER-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Ensure jQuery full for ajax -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const BASE_URL = "http://localhost:8888/api";

    async function getOrCreateCartId() {
        const authToken = localStorage.getItem('authToken');
        const savedUser = localStorage.getItem('currentUser');
        if (!authToken || !savedUser) {
            alert("Vui lòng đăng nhập để xem giỏ hàng!");
            window.location.href = 'login.html';
            return null;
        }
        const user = JSON.parse(savedUser);
        const userId = user.id;
        const headers = { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' };

        try {
            let cartId;
            // Tìm cart hiện có
            const cartsRes = await fetch(`${BASE_URL}/carts?userID=${userId}&itemPerPage=1&page=1`, { headers });
            if (cartsRes.ok) {
                const cartsData = await cartsRes.json();
                if (cartsData.data?.list?.length > 0) {
                    cartId = cartsData.data.list[0].id;
                }
            }

            // Nếu không có → tạo mới (với retry nếu unique error)
            if (!cartId) {
                const createCartRes = await fetch(`${BASE_URL}/carts`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ userID: userId })
                });
                if (!createCartRes.ok) {
                    // Retry tìm lại nếu lỗi unique
                    const retryRes = await fetch(`${BASE_URL}/carts?userID=${userId}&itemPerPage=1&page=1`, { headers });
                    if (retryRes.ok) {
                        const retryData = await retryRes.json();
                        if (retryData.data?.list?.length > 0) {
                            cartId = retryData.data.list[0].id;
                        }
                    }
                    if (!cartId) throw new Error("Không thể tạo hoặc tìm cart");
                } else {
                    const createCartData = await createCartRes.json();
                    cartId = createCartData.data.id;
                }
            }
            return cartId;
        } catch (err) {
            console.error(err);
            alert("Lỗi lấy/tạo cart: " + err.message);
            return null;
        }
    }

    // Load và render cart items
    async function loadCartItems() {
        const cartId = await getOrCreateCartId();
        if (!cartId) return;

        const authToken = localStorage.getItem('authToken');
        const headers = { 'Authorization': `Bearer ${authToken}` };

        try {
            const itemsRes = await fetch(`${BASE_URL}/cart-items?cartId=${cartId}&itemPerPage=100&page=1`, { headers });
            if (!itemsRes.ok) throw new Error("Lỗi load cart items");
            const itemsData = await itemsRes.json();
            let items = itemsData.data.list || [];

            let total = 0;
            for (let item of items) {
                // Backend có thể trả productVariant hoặc chỉ variantId → fetch thêm nếu cần
                let variantId = item.productVariantID || item.productVariantId; // hỗ trợ cả hai
                if (!item.product && variantId) {
                    const variantRes = await fetch(`${BASE_URL}/product-variants/${variantId}`, { headers });
                    if (variantRes.ok) {
                        const variantData = await variantRes.json();
                        item.productVariant = variantData.data;

                        // Fetch product từ variant
                        const productId = item.productVariant.productID;
                        const productRes = await fetch(`${BASE_URL}/products/${productId}`, { headers });
                        if (productRes.ok) {
                            const productData = await productRes.json();
                            item.product = productData.data;
                        }
                    }
                }

                // Lấy info hiển thị
                item.name = item.product?.name || 'Sản phẩm không tên';
                item.price = item.productVariant?.price || item.product?.price || 0;
                item.mainImage = item.product?.productImages?.[0]?.imageUrl || "../../img/default-product.jpg";
                item.quantity = item.quantity || 1;
                item.id = item.id; // cart-item id

                const itemTotal = item.price * item.quantity;
                total += itemTotal;
            }

            renderCartItems(items, total);
        } catch (err) {
            console.error(err);
            $('#cartItemsBody').html('<tr><td colspan="5" class="text-center text-danger">Lỗi tải giỏ hàng</td></tr>');
        }
    }

    function renderCartItems(items, total = 0) {
        const tbody = $('#cartItemsBody');
        tbody.empty();

        if (items.length === 0) {
            tbody.html('<tr><td colspan="5" class="text-center">Giỏ hàng trống</td></tr>');
            $('#cartTotal').text('0 ₫');
            return;
        }

        items.forEach(item => {
            const priceStr = Number(item.price).toLocaleString('vi-VN') + ' ₫';
            const itemTotal = item.price * item.quantity;
            const itemTotalStr = Number(itemTotal).toLocaleString('vi-VN') + ' ₫';

            tbody.append(`
                <tr data-item-id="${item.id}">
                    <td>
                        <img src="${item.mainImage}" style="max-width: 80px; margin-right: 10px;">
                        ${item.name}
                    </td>
                    <td>${priceStr}</td>
                    <td>
                        <div class="js-qty d-inline-block">
                            <button class="qty-minus btn btn-outline-dark btn-sm" type="button">-</button>
                            <input type="text" class="js-qty-num form-control text-center d-inline-block mx-2" value="${item.quantity}" style="width: 60px;">
                            <button class="qty-plus btn btn-outline-dark btn-sm" type="button">+</button>
                        </div>
                    </td>
                    <td class="item-total">${itemTotalStr}</td>
                    <td><button class="btn btn-danger btn-sm remove-item">Xóa</button></td>
                </tr>
            `);
        });

        $('#cartTotal').text(Number(total).toLocaleString('vi-VN') + ' ₫');
    }

    // Handle qty change
    $(document).on('click', '.qty-minus', function() {
        const input = $(this).siblings('.js-qty-num');
        let qty = parseInt(input.val());
        if (qty > 1) {
            input.val(qty - 1);
            updateItemQuantity($(this).closest('tr'));
        }
    });

    $(document).on('click', '.qty-plus', function() {
        const input = $(this).siblings('.js-qty-num');
        let qty = parseInt(input.val());
        input.val(qty + 1);
        updateItemQuantity($(this).closest('tr'));
    });

    $(document).on('change', '.js-qty-num', function() {
        let qty = parseInt($(this).val());
        if (isNaN(qty) || qty < 1) $(this).val(1);
        updateItemQuantity($(this).closest('tr'));
    });

    // Update quantity (PATCH)
    async function updateItemQuantity(row) {
        const itemId = row.data('item-id');
        const newQty = parseInt(row.find('.js-qty-num').val());

        const authToken = localStorage.getItem('authToken');
        const headers = { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' };

        try {
            const updateRes = await fetch(`${BASE_URL}/cart-items/${itemId}`, {
                method: 'PATCH',
                headers,
                body: JSON.stringify({ quantity: newQty })
            });
            if (!updateRes.ok) throw new Error("Lỗi cập nhật số lượng");

            // Update total hiển thị
            const price = parseFloat(row.find('td:nth-child(2)').text().replace(/[^0-9]/g, ''));
            const itemTotal = price * newQty;
            row.find('.item-total').text(Number(itemTotal).toLocaleString('vi-VN') + ' ₫');

            // Recalc grand total
            let grandTotal = 0;
            $('#cartItemsBody .item-total').each(function() {
                grandTotal += parseFloat($(this).text().replace(/[^0-9]/g, ''));
            });
            $('#cartTotal').text(Number(grandTotal).toLocaleString('vi-VN') + ' ₫');

        } catch (err) {
            console.error(err);
            alert("Lỗi cập nhật số lượng: " + err.message);
            loadCartItems(); // reload nếu lỗi
        }
    }

    // Handle remove item
    $(document).on('click', '.remove-item', async function() {
        if (!confirm("Xác nhận xóa sản phẩm khỏi giỏ hàng?")) return;

        const row = $(this).closest('tr');
        const itemId = row.data('item-id');

        const authToken = localStorage.getItem('authToken');
        const headers = { 'Authorization': `Bearer ${authToken}` };

        try {
            const deleteRes = await fetch(`${BASE_URL}/cart-items/${itemId}`, { method: 'DELETE', headers });
            if (!deleteRes.ok) throw new Error("Lỗi xóa sản phẩm");

            row.remove();

            // Recalc total
            let grandTotal = 0;
            $('#cartItemsBody .item-total').each(function() {
                grandTotal += parseFloat($(this).text().replace(/[^0-9]/g, ''));
            });
            $('#cartTotal').text(Number(grandTotal).toLocaleString('vi-VN') + ' ₫');

            if ($('#cartItemsBody tr').length === 0) {
                $('#cartItemsBody').html('<tr><td colspan="5" class="text-center">Giỏ hàng trống</td></tr>');
            }

        } catch (err) {
            console.error(err);
            alert("Lỗi xóa sản phẩm: " + err.message);
        }
    });

    // Nút UPDATE CART → chỉ reload để đồng bộ
    $('#updateCartBtn').on('click', function(e) {
        e.preventDefault();
        loadCartItems();
        alert("Giỏ hàng đã được cập nhật!");
    });

    // Load khi mở trang
    $(document).ready(function() {
        loadCartItems();
    });
</script>
</body>
</html>