<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart | Mabu Store</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
          integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.2.3/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.2.3/ionicons/ionicons.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <link rel="stylesheet" href="../../css/cart.css">
</head>

<body>
<!--HEADER-->
<header>
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: white">
        <div class="container-fluid container-fluid-v1">
            <button class="navbar-toggler" type="button" data-toggle="collapse"
                    data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav">
                    <div class="nav-item">
                        <a class="nav-link text-body" href="../customer/index.html">HOME</a>
                    </div>
                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown2" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">PRODUCT
                            <span class="absolute label_menu">HOT</span>
                        </a>

                        <div class="dropdown-menu dropdown-menu-left border-0 rounded-0"
                             aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="product.html">ALL ITEMS</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Sneaker</a>
                                    <a class="dropdown-item text-secondary" href="#">Converse</a>
                                    <a class="dropdown-item text-secondary" href="#">Adidas</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">PRODUCTS</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Hot Trend</a>
                                    <a class="dropdown-item text-secondary" href="#">Best Seller</a>
                                    <a class="dropdown-item text-secondary" href="#">Fashion</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">POPULAR</a>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header1.jpg" />
                                                    <ul class="col-sm-7">
                                                        SB Chron British Tan<br>
                                                        $ 500.00
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header2.jpg" />
                                                    <ul class="col-sm-7">
                                                        Converse Chuck Taylor Star<br>
                                                        $ 500.00
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header3.jpg" />
                                                    <ul class="col-sm-7">
                                                        Converse Unisex Shoes<br>
                                                        $ 300.00
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <img src="../../img/img_header.jpg" alt="" style="width: 650px; margin: 25px;">
                        </div>
                    </div>

                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown3" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">FEATURED</a>
                        <div class="dropdown-menu dropdown-menu-left border-0 rounded-0"
                             aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                            </div>
                            <img src="../../img/img_header.jpg" alt="" style="width: 650px; margin: 25px;">
                        </div>
                    </div>

                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown4" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">PAGES</a>
                        <div class="dropdown-menu dropdown-menu-right border-0 rounded-0"
                             aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a class="nav-link text-body" href="#" id="navbarDropdown" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">BLOGS</a>
                        <div class="dropdown-menu dropdown-menu-right border-0 rounded-0"
                             aria-labelledby="dropdownMenuButton" style="width: 700px;">
                            <div class="row">
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                    <a class="dropdown-item text-secondary" href="#">Separated link</a>
                                </div>
                                <div class="col-sm">
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header1.jpg" />
                                                    <ul class="col-sm-7">
                                                        SB Chron British Tan<br>
                                                        $ 500.00
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header2.jpg" />
                                                    <ul class="col-sm-7">
                                                        Converse Chuck Taylor Star<br>
                                                        $ 500.00
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="poly-cart">
                                        <div class="panel panel-default">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <img class="col-sm-5" src="../../img/img_header3.jpg" />
                                                    <ul class="col-sm-7">
                                                        Converse Unisex Shoes<br>
                                                        $ 300.00
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </ul>
            </div>
            <img src="../../img/mega_mall_logo.png" width="5%" style="margin-right: 450px;">
            <div class="icon" style="display: inherit">
                <a href="profile.html"><i class="far fa-user fa-fw mx-3" data-toggle="modal" data-target="#exampleModalCenter"></i></a>
                <a href="notification.html"><i class="fas fa-bell fa-fw mx-3"></i></a>
                <a href="order.html"><i class="fas fa-list-alt fa-fw mx-3"></i></a>
                <a href="cart.html"><i class="fas fa-dolly fa-fw mx-3"></i></a>
            </div>
        </div>
    </nav>
</header>
<!--HEADER END-->


<!-- CART -->
<section>
    <div class="container">
        <table class="table">
            <thead>
            <tr>
                <th scope="col">PRODUCT NAME</th>
                <th scope="col">PRICE</th>
                <th scope="col">QUANTITY</th>
                <th scope="col">TOTAL</th>
                <th scope="col">ACTION</th>
            </tr>
            </thead>
            <tbody id="cartItemsBody"></tbody>
        </table>
        <div class="cart-update">
            <input type="submit" class="button" value="UPDATE CART" id="updateCartBtn">
        </div>
        <div class="continue-shopping">
            <a href="product.html">CONTINUE SHOPPING</a>
        </div>
        <div class="cart-check">
            <h2 class="cart-title">CART TOTAL</h2>
            <table class="total-checkout">
                <tbody>
                <tr>
                    <th class="cart-label"><span>Total</span></th>
                    <td class="cart-amount">
                        <span><strong><span id="cartTotal" class="amount">0 ₫</span></strong></span>
                    </td>
                </tr>
                </tbody>
            </table>
            <div class="proceed-to-checkout">
                <button id="proceedCheckoutBtn" class="checkout-button">PROCEED TO CHECKOUT</button>
            </div>
        </div>
    </div>
</section>

<!-- TOAST CONTAINER -->
<div aria-live="polite" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 1050;">
    <div id="toastContainer"></div>
</div>

<!-- FOOTER -->
<footer class="footer mt-5">
    <div class="top-footer">
        <div class="row footerreponsive">
            <div class="col-sm-3">
                <div class="info_footer end">
                    <div class="logo-top">
                        <a href="" class="logo">
                            <img src="../../img/mega_mall_logo_black.png" style="width: 50%;">
                        </a>
                    </div>
                    <div class="mb-0 content_footer" style="margin-top: 23px;">
                        University of Information Technology (VNUHCM – UIT)<br>
                        (028) 372 52002 <br>
                        (028) 372 52148 <br>
                        info@uit.edu.vn
                    </div>
                    <div class="list-icon">
                        <ul class="list-inline list-unstyled mb-0">
                            <li class="list-inline-item"><a href="" class="social-item"><i class="fab fa-twitter"></i></a></li>
                            <li class="list-inline-item"><a href="" class="social-item"><i class="fab fa-weixin"></i></a></li>
                            <li class="list-inline-item"><a href="" class="social-item"><i class="fab fa-weibo"></i></a></li>
                            <li class="list-inline-item"><a href="" class="social-item"><i class="fab fa-skype"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">Help & Information <br><hr class="hr"></h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li><a href="">Pagination</a></li>
                        <li><a href="">Terms & Conditions</a></li>
                        <li><a href="">Contact</a></li>
                        <li><a href="">Accessories</a></li>
                        <li><a href="">Term of use</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">About Us <br><hr class="hr"></h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li><a href="">Help Center</a></li>
                        <li><a href="">Address Store</a></li>
                        <li><a href="">Privacy Policy</a></li>
                        <li><a href="">Receivers & Amplifiers</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-sm-3" style="line-height: 34px;">
                <div class="info_footer">
                    <div class="title_footer">
                        <h4 class="mb-0 title_border">Profile <br><hr class="hr"></h4>
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li><a href="">My Account</a></li>
                        <li><a href="">Checkout</a></li>
                        <li><a href="">Order Tracking</a></li>
                        <li><a href="">Help & Support</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <hr style="background-color: white;">
    <div class="copyright" style="color: white;">
        <div class="row align-items-center">
            <div class="col-lg-6 col-md-6 text-lg-left text-md-left">
                <div class="text-copyright mb-0">
                    © Copyright 2025 | <a href="" class="underline_hover bold">Designed</a> by <a href="" class="underline_hover link">Mega Mall</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<script>
    const BASE_URL = "http://localhost:8888/api";

    function showToast(message, type = 'success') {
        const toastHtml = `
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="4000">
          <div class="toast-header bg-${type === 'success' ? 'success' : (type === 'warning' ? 'warning' : 'danger')} text-white">
            <strong class="mr-auto">${type === 'success' ? 'Success' : (type === 'warning' ? 'Warning' : 'Error')}</strong>
            <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="toast-body">${message}</div>
        </div>`;
        $('#toastContainer').append(toastHtml);
        $('.toast').last().toast('show');
        $('.toast').last().on('hidden.bs.toast', function () {
            $(this).remove();
        });
    }

    async function getOrCreateCartId() {
        const authToken = localStorage.getItem('authToken');
        const savedUser = localStorage.getItem('currentUser');

        if (!authToken || !savedUser) {
            showToast('Please log in to view your cart', 'warning');
            window.location.href = 'login.html';
            return null;
        }

        const user = JSON.parse(savedUser);
        const userId = user.id;
        const headers = { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' };

        try {
            let cartId;
            const cartsRes = await fetch(`${BASE_URL}/carts?userID=${userId}&itemPerPage=1&page=1`, { headers });
            if (cartsRes.ok) {
                const cartsData = await cartsRes.json();
                if (cartsData.data?.list?.length > 0) {
                    cartId = cartsData.data.list[0].id;
                }
            }

            if (!cartId) {
                const createCartRes = await fetch(`${BASE_URL}/carts`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ userID: userId })
                });

                if (!createCartRes.ok) {
                    const retryRes = await fetch(`${BASE_URL}/carts?userID=${userId}&itemPerPage=1&page=1`, { headers });
                    if (retryRes.ok) {
                        const retryData = await retryRes.json();
                        if (retryData.data?.list?.length > 0) {
                            cartId = retryData.data.list[0].id;
                        }
                    }
                    if (!cartId) throw new Error('Unable to create or find cart');
                } else {
                    const createCartData = await createCartRes.json();
                    cartId = createCartData.data.id;
                }
            }
            return cartId;
        } catch (err) {
            console.error(err);
            showToast('Error accessing cart', 'danger');
            return null;
        }
    }

    async function loadCartItems(retryCount = 0) {
        const cartId = await getOrCreateCartId();
        if (!cartId) return;

        const authToken = localStorage.getItem('authToken');
        const headers = { 'Authorization': `Bearer ${authToken}` };

        try {
            const itemsRes = await fetch(`${BASE_URL}/cart-items?cartID=${cartId}&itemPerPage=100&page=1`, { headers });
            if (!itemsRes.ok) throw new Error('Failed to load cart items');

            const itemsData = await itemsRes.json();
            let items = itemsData.data?.list || [];

            localStorage.removeItem('just_added_to_cart');

            let total = 0;
            for (let item of items) {
                let variantId = item.productVariantID || item.productVariantId;
                if (!item.product && variantId) {
                    const variantRes = await fetch(`${BASE_URL}/product-variants/${variantId}`, { headers });
                    if (variantRes.ok) {
                        const variantData = await variantRes.json();
                        item.productVariant = variantData.data;

                        const productId = item.productVariant.productID;
                        const productRes = await fetch(`${BASE_URL}/products/${productId}?include=productImages`, { headers });
                        if (productRes.ok) {
                            const productData = await productRes.json();
                            item.product = productData.data;
                        }
                    }
                }

                item.name = item.product?.name || 'Unnamed Product';
                item.price = item.productVariant?.price || item.product?.price || 0;
                item.mainImage = item.product?.productImages?.[0]?.imageUrl || item.productVariant?.imageUrl || "https://via.placeholder.com/300x300/eeeeee/999999?text=No+Image";
                item.quantity = item.quantity || 1;
                item.id = item.id;

                const itemTotal = item.price * item.quantity;
                total += itemTotal;
            }

            renderCartItems(items, total);
        } catch (err) {
            console.error(err);
            $('#cartItemsBody').html('<tr><td colspan="5" class="text-center text-danger">Failed to load cart</td></tr>');
            showToast('Failed to load cart', 'danger');
        }
    }

    function renderCartItems(items, total = 0) {
        const tbody = $('#cartItemsBody');
        tbody.empty();

        if (items.length === 0) {
            tbody.html('<tr><td colspan="5" class="text-center py-5 text-muted">Your cart is empty</td></tr>');
            $('#cartTotal').text('0 ₫');
            return;
        }

        items.forEach(item => {
            const priceStr = Number(item.price).toLocaleString() + ' ₫';
            const itemTotal = item.price * item.quantity;
            const itemTotalStr = Number(itemTotal).toLocaleString() + ' ₫';

            tbody.append(`
          <tr data-item-id="${item.id}" data-price="${item.price}" data-quantity="${item.quantity}">
            <td class="align-middle"><strong>${item.name}</strong></td>
            <td class="align-middle">${priceStr}</td>
            <td class="align-middle">
              <div class="js-qty d-inline-block">
                <button class="qty-minus btn btn-outline-dark btn-sm" type="button">-</button>
                <input type="text" class="js-qty-num form-control text-center d-inline-block mx-2" value="${item.quantity}" style="width: 60px;">
                <button class="qty-plus btn btn-outline-dark btn-sm" type="button">+</button>
              </div>
            </td>
            <td class="align-middle item-total">${itemTotalStr}</td>
            <td class="align-middle text-center">
              <button class="btn btn-danger btn-sm remove-item">
                <i class="fas fa-trash-alt"></i> Remove
              </button>
            </td>
          </tr>
        `);
        });

        $('#cartTotal').text(Number(total).toLocaleString() + ' ₫');
    }

    $(document).on('click', '.remove-item', async function() {
        const row = $(this).closest('tr');
        const itemId = row.data('item-id');

        if (!itemId) {
            showToast('Error: Item ID not found', 'danger');
            return;
        }

        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            showToast('Please log in again', 'warning');
            window.location.href = 'login.html';
            return;
        }

        try {
            const res = await fetch(`${BASE_URL}/cart-items/${itemId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (res.ok || res.status === 204) {
                showToast('Item removed successfully', 'success');
                row.remove();

                let grandTotal = 0;
                $('#cartItemsBody tr').each(function() {
                    const p = parseFloat($(this).attr('data-price')) || 0;
                    const q = parseFloat($(this).attr('data-quantity')) || 1;
                    grandTotal += p * q;
                });
                $('#cartTotal').text(Number(grandTotal).toLocaleString() + ' ₫');

                if ($('#cartItemsBody tr').length === 0) {
                    $('#cartItemsBody').html('<tr><td colspan="5" class="text-center py-5 text-muted">Your cart is empty</td></tr>');
                    $('#cartTotal').text('0 ₫');
                }
            } else {
                const err = await res.json();
                showToast('Remove failed: ' + (err.message || 'Server error'), 'danger');
            }
        } catch (err) {
            console.error(err);
            showToast('Connection error', 'danger');
        }
    });

    $(document).on('click', '.qty-minus', function() {
        const input = $(this).siblings('.js-qty-num');
        let qty = parseInt(input.val());
        if (qty > 1) {
            input.val(qty - 1);
            updateItemQuantity($(this).closest('tr'));
        }
    });

    $(document).on('click', '.qty-plus', function() {
        const input = $(this).siblings('.js-qty-num');
        let qty = parseInt(input.val());
        input.val(qty + 1);
        updateItemQuantity($(this).closest('tr'));
    });

    $(document).on('change', '.js-qty-num', function() {
        let qty = parseInt($(this).val());
        if (isNaN(qty) || qty < 1) $(this).val(1);
        updateItemQuantity($(this).closest('tr'));
    });

    async function updateItemQuantity(row) {
        const itemId = row.data('item-id');
        const newQty = parseInt(row.find('.js-qty-num').val());
        const authToken = localStorage.getItem('authToken');
        const headers = { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' };

        try {
            const updateRes = await fetch(`${BASE_URL}/cart-items/${itemId}`, {
                method: 'PATCH',
                headers,
                body: JSON.stringify({ quantity: newQty })
            });

            if (!updateRes.ok) throw new Error('Failed to update quantity');

            row.attr('data-quantity', newQty);
            const price = parseFloat(row.attr('data-price'));
            const itemTotal = price * newQty;
            row.find('.item-total').text(Number(itemTotal).toLocaleString() + ' ₫');

            let grandTotal = 0;
            $('#cartItemsBody tr').each(function() {
                const p = parseFloat($(this).attr('data-price')) || 0;
                const q = parseFloat($(this).attr('data-quantity')) || 1;
                grandTotal += p * q;
            });
            $('#cartTotal').text(Number(grandTotal).toLocaleString() + ' ₫');
        } catch (err) {
            console.error(err);
            showToast('Failed to update quantity', 'danger');
            loadCartItems();
        }
    }

    $('#updateCartBtn').on('click', function(e) {
        e.preventDefault();
        loadCartItems();
        showToast('Cart updated successfully', 'success');
    });

        $('#proceedCheckoutBtn').on('click', async function(e) {
        e.preventDefault();

        const authToken = localStorage.getItem('authToken');
        const savedUser = localStorage.getItem('currentUser');

        if (!authToken || !savedUser) {
        showToast('Please log in to place an order', 'warning');
        window.location.href = 'login.html';
        return;
    }

        const user = JSON.parse(savedUser);
        const userId = user.id;
        const headers = { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' };

        try {
        const cartId = await getOrCreateCartId();
        if (!cartId) throw new Error('Cart not found');

        const itemsRes = await fetch(`${BASE_URL}/cart-items?cartID=${cartId}&itemPerPage=100&page=1`, { headers });
        if (!itemsRes.ok) throw new Error('Failed to retrieve cart items');

        const itemsData = await itemsRes.json();
        const cartItems = itemsData.data?.list || [];

        if (cartItems.length === 0) {
        showToast('Your cart is empty', 'warning');
        return;
    }

        let subtotal = 0;
        const orderItemsCreate = [];

        for (let item of cartItems) {
        const variantId = item.productVariantID || item.productVariantId;
        const quantity = item.quantity || 1;
        let price = 0;

        if (variantId) {
        const variantRes = await fetch(`${BASE_URL}/product-variants/${variantId}`, { headers });
        if (variantRes.ok) {
        const vData = await variantRes.json();
        price = vData.data.price || 0;
    }
    }

        const itemTotal = price * quantity;
        subtotal += itemTotal;

        orderItemsCreate.push({
        productVariantID: variantId,
        quantity: quantity,
        unitPrice: price,
        totalPrice: itemTotal
    });
    }

        const orderNumber = 'ORD-' + Date.now() + '-' + Math.floor(Math.random() * 1000);

        const payload = {
        orderNumber: orderNumber,
        userID: userId,
        subtotal: subtotal,
        taxAmount: 0,
        shippingAmount: 0,
        discountAmount: 0,
        totalAmount: subtotal,
        currency: "VND",
        status: 'pending',
        orderItems: { create: orderItemsCreate }
    };

        const createOrderRes = await fetch(`${BASE_URL}/orders`, {
        method: 'POST',
        headers,
        body: JSON.stringify(payload)
    });

        if (!createOrderRes.ok) {
        const errData = await createOrderRes.json();
        throw new Error(errData.message || 'Failed to create order');
    }

        const orderData = await createOrderRes.json();
        showToast(`Order placed successfully! Order ID: ${orderData.data.orderNumber}`, 'success');

        for (let item of cartItems) {
        await fetch(`${BASE_URL}/cart-items/${item.id}`, {
        method: 'DELETE',
        headers
    });
    }

        showToast('Cart cleared after successful order', 'success');

        setTimeout(() => {
        window.location.reload();
    }, 2000);

    } catch (err) {
        console.error(err);
        showToast('Order failed: ' + err.message, 'danger');
    }
    });

    $(document).ready(function() {
        loadCartItems();
    });
</script>
</body>
</html>